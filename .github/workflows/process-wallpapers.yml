name: Process Wallpapers

on:
  repository_dispatch:
    types: [process-wallpapers]
  workflow_dispatch:
    inputs:
      commit_message:
        description: 'Êèê‰∫§‰ø°ÊÅØ'
        required: false
        default: 'chore: update wallpapers'

env:
  IMAGE_REPO: IT-NuanxinPro/nuanXinProPic

jobs:
  process:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout workflow repo
        uses: actions/checkout@v4
      
      - name: Checkout image repo
        uses: actions/checkout@v4
        with:
          repository: ${{ env.IMAGE_REPO }}
          token: ${{ secrets.REPO_TOKEN }}
          path: nuanXinProPic
          fetch-depth: 0
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      
      - name: Install dependencies
        run: |
          # ImageMagick
          sudo apt-get update
          sudo apt-get install -y imagemagick fonts-noto-cjk
          
          # ÈÖçÁΩÆ ImageMagick Á≠ñÁï•
          sudo sed -i 's/<policy domain="resource" name="memory" value="256MiB"\/>/<policy domain="resource" name="memory" value="2GiB"\/>/g' /etc/ImageMagick-6/policy.xml || true
          sudo sed -i 's/<policy domain="resource" name="disk" value="1GiB"\/>/<policy domain="resource" name="disk" value="8GiB"\/>/g' /etc/ImageMagick-6/policy.xml || true
      
      - name: Process new images
        id: process
        run: |
          chmod +x scripts/*.sh
          ./scripts/process-new-images.sh nuanXinProPic
          
          # ËØªÂèñÂ§ÑÁêÜÊï∞Èáè
          if [ -f /tmp/processed_count.txt ]; then
            COUNT=$(cat /tmp/processed_count.txt)
            echo "count=$COUNT" >> $GITHUB_OUTPUT
            [ "$COUNT" -gt 0 ] && echo "has_new=true" >> $GITHUB_OUTPUT || echo "has_new=false" >> $GITHUB_OUTPUT
          else
            echo "count=0" >> $GITHUB_OUTPUT
            echo "has_new=false" >> $GITHUB_OUTPUT
          fi
      
      - name: Verify timestamps (optional)
        if: steps.process.outputs.has_new == 'true'
        continue-on-error: true
        run: |
          # Ê†°È™åÊï∞ÊçÆ‰∏ÄËá¥ÊÄßÔºåÂèëÁé∞ÈóÆÈ¢òËá™Âä®‰øÆÂ§ç
          ./scripts/verify-timestamps.sh nuanXinProPic --fix || true
      
      - name: Update timestamps
        if: steps.process.outputs.has_new == 'true'
        run: |
          # ÂÖàÊõ¥Êñ∞Êó∂Èó¥Êà≥ÔºåËøôÊ†∑ create-release ÊâçËÉΩÊ≠£Á°ÆÁªüËÆ°ÊÄªÊï∞
          ./scripts/update-timestamps.sh nuanXinProPic
      
      - name: Create release
        if: steps.process.outputs.has_new == 'true'
        env:
          GH_TOKEN: ${{ secrets.REPO_TOKEN }}
        run: |
          # Ëé∑ÂèñÊèê‰∫§‰ø°ÊÅØ
          if [ -n "${{ github.event.inputs.commit_message }}" ]; then
            MSG="${{ github.event.inputs.commit_message }}"
          elif [ -n "${{ github.event.client_payload.message }}" ]; then
            MSG="${{ github.event.client_payload.message }}"
          else
            MSG="chore: update wallpapers [$(TZ='Asia/Shanghai' date +'%Y-%m-%d')]"
          fi
          
          # Ëé∑ÂèñÂèëÂ∏ÉËÄÖ
          PUBLISHER="${{ github.event.client_payload.publisher }}"
          
          ./scripts/create-release.sh nuanXinProPic "$MSG" "$PUBLISHER"
      
      - name: Summary
        run: |
          echo "## üéâ Workflow Complete" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ "${{ steps.process.outputs.has_new }}" == "true" ]; then
            echo "- ‚úÖ Processed **${{ steps.process.outputs.count }}** new images" >> $GITHUB_STEP_SUMMARY
            echo "- ‚úÖ Created release" >> $GITHUB_STEP_SUMMARY
          else
            echo "- ‚ÑπÔ∏è No new images to process" >> $GITHUB_STEP_SUMMARY
          fi
