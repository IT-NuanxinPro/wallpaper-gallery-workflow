name: Process Wallpapers

on:
  repository_dispatch:
    types: [process-wallpapers]
  workflow_dispatch:
    inputs:
      commit_message:
        description: 'æäº¤ä¿¡æ¯'
        required: false
        default: 'chore: update wallpapers'

# P0 ä¿®å¤ï¼šå¹¶å‘æ§åˆ¶ - é˜²æ­¢å¤šä¸ªå·¥ä½œæµåŒæ—¶å¤„ç†ç›¸åŒæ–‡ä»¶
concurrency:
  group: process-wallpapers
  cancel-in-progress: false  # ä¸å–æ¶ˆæ­£åœ¨è¿è¡Œçš„ï¼Œæ’é˜Ÿæ‰§è¡Œ

env:
  IMAGE_REPO: IT-NuanxinPro/nuanXinProPic

jobs:
  process:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout workflow repo
        uses: actions/checkout@v4
      
      - name: Checkout image repo
        uses: actions/checkout@v4
        with:
          repository: ${{ env.IMAGE_REPO }}
          token: ${{ secrets.REPO_TOKEN }}
          path: nuanXinProPic
          fetch-depth: 0
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      
      - name: Install dependencies
        run: |
          # ImageMagick
          sudo apt-get update
          sudo apt-get install -y imagemagick fonts-noto-cjk
          
          # é…ç½® ImageMagick ç­–ç•¥
          sudo sed -i 's/<policy domain="resource" name="memory" value="256MiB"\/>/<policy domain="resource" name="memory" value="2GiB"\/>/g' /etc/ImageMagick-6/policy.xml || true
          sudo sed -i 's/<policy domain="resource" name="disk" value="1GiB"\/>/<policy domain="resource" name="disk" value="8GiB"\/>/g' /etc/ImageMagick-6/policy.xml || true
      
      - name: Process new images
        id: process
        run: |
          chmod +x scripts/*.sh
          ./scripts/process-new-images.sh nuanXinProPic

          # è¯»å–å¤„ç†æ•°é‡
          if [ -f /tmp/processed_count.txt ]; then
            COUNT=$(cat /tmp/processed_count.txt)
            echo "count=$COUNT" >> $GITHUB_OUTPUT
            [ "$COUNT" -gt 0 ] && echo "has_new=true" >> $GITHUB_OUTPUT || echo "has_new=false" >> $GITHUB_OUTPUT
          else
            echo "count=0" >> $GITHUB_OUTPUT
            echo "has_new=false" >> $GITHUB_OUTPUT
          fi

      - name: Check pending metadata
        id: check_metadata
        run: |
          # æ£€æŸ¥æ˜¯å¦æœ‰å¾…å¤„ç†çš„ metadata-pending æ–‡ä»¶
          PENDING_DIR="nuanXinProPic/metadata-pending"
          if [ -d "$PENDING_DIR" ] && [ "$(ls -A $PENDING_DIR/*.json 2>/dev/null | wc -l)" -gt 0 ]; then
            echo "has_pending=true" >> $GITHUB_OUTPUT
          else
            echo "has_pending=false" >> $GITHUB_OUTPUT
          fi

      - name: Create tag
        if: steps.process.outputs.has_new == 'true' || steps.check_metadata.outputs.has_pending == 'true'
        run: |
          # è·å–æäº¤ä¿¡æ¯
          if [ -n "${{ github.event.inputs.commit_message }}" ]; then
            MSG="${{ github.event.inputs.commit_message }}"
          elif [ -n "${{ github.event.client_payload.message }}" ]; then
            MSG="${{ github.event.client_payload.message }}"
          else
            MSG="chore: å¤„ç† ${{ steps.process.outputs.count }} å¼ æ–°å›¾ç‰‡"
          fi

          # ç¬¬ä¸€æ­¥ï¼šæäº¤ç¼©ç•¥å›¾/é¢„è§ˆå›¾ï¼Œåˆ›å»ºå¹¶æ¨é€ tag
          ./scripts/create-tag.sh nuanXinProPic "$MSG"

      - name: Update timestamps
        if: steps.process.outputs.has_new == 'true'
        run: |
          # ç¬¬äºŒæ­¥ï¼šç”¨æ–° tag æ›´æ–°æ—¶é—´æˆ³æ–‡ä»¶
          # è¯»å–åˆšåˆ›å»ºçš„ tag
          NEW_TAG=$(cat /tmp/new_tag.txt)
          ./scripts/update-timestamps.sh nuanXinProPic "$NEW_TAG"

      - name: Verify timestamps
        if: steps.process.outputs.has_new == 'true'
        continue-on-error: true
        run: |
          # ç¬¬ä¸‰æ­¥ï¼šæ ¡éªŒæ•°æ®ä¸€è‡´æ€§ï¼Œç”¨æ–° tag ä¿®å¤é—æ¼
          NEW_TAG=$(cat /tmp/new_tag.txt)
          ./scripts/verify-timestamps.sh nuanXinProPic --fix "$NEW_TAG" || true

      - name: Verify data integrity
        if: steps.process.outputs.has_new == 'true' || steps.check_metadata.outputs.has_pending == 'true'
        continue-on-error: true
        run: |
          # P0 ä¿®å¤ï¼šæ•°æ®å®Œæ•´æ€§éªŒè¯
          ./scripts/verify-integrity.sh nuanXinProPic || true

      - name: Process metadata-pending
        id: metadata
        if: steps.process.outputs.has_new == 'true' || steps.check_metadata.outputs.has_pending == 'true'
        run: |
          # åœ¨ tag åˆ›å»ºä¹‹åå¤„ç† metadataï¼Œç¡®ä¿ä½¿ç”¨æ­£ç¡®çš„æ–° tag
          NEW_TAG=$(cat /tmp/new_tag.txt)
          node scripts/process-metadata.js nuanXinProPic "$NEW_TAG"

          # è¯»å–metadataå¤„ç†æ•°é‡
          if [ -f /tmp/metadata_processed.txt ]; then
            META_COUNT=$(cat /tmp/metadata_processed.txt)
            echo "meta_count=$META_COUNT" >> $GITHUB_OUTPUT
            [ "$META_COUNT" -gt 0 ] && echo "has_metadata=true" >> $GITHUB_OUTPUT || echo "has_metadata=false" >> $GITHUB_OUTPUT
          else
            echo "meta_count=0" >> $GITHUB_OUTPUT
            echo "has_metadata=false" >> $GITHUB_OUTPUT
          fi

      - name: Publish release
        if: steps.process.outputs.has_new == 'true' || steps.metadata.outputs.has_metadata == 'true'
        env:
          GH_TOKEN: ${{ secrets.REPO_TOKEN }}
        run: |
          # è·å–æäº¤ä¿¡æ¯
          if [ -n "${{ github.event.inputs.commit_message }}" ]; then
            MSG="${{ github.event.inputs.commit_message }}"
          elif [ -n "${{ github.event.client_payload.message }}" ]; then
            MSG="${{ github.event.client_payload.message }}"
          else
            IMG_COUNT="${{ steps.process.outputs.count }}"
            META_COUNT="${{ steps.metadata.outputs.meta_count }}"
            MSG="chore: å¤„ç† ${IMG_COUNT} å¼ æ–°å›¾ç‰‡, ${META_COUNT} æ¡å…ƒæ•°æ®"
          fi

          # è·å–å‘å¸ƒè€…
          PUBLISHER="${{ github.event.client_payload.publisher }}"

          # ç¬¬ä¸‰æ­¥ï¼šæ›´æ–° stats.jsonï¼Œæäº¤ï¼Œå‘å¸ƒ release
          ./scripts/publish-release.sh nuanXinProPic "$MSG" "$PUBLISHER"

      - name: Summary
        run: |
          echo "## ğŸ‰ Workflow Complete" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ "${{ steps.process.outputs.has_new }}" == "true" ]; then
            echo "- âœ… Processed **${{ steps.process.outputs.count }}** new images" >> $GITHUB_STEP_SUMMARY
          else
            echo "- â„¹ï¸ No new images to process" >> $GITHUB_STEP_SUMMARY
          fi

          if [ "${{ steps.metadata.outputs.has_metadata }}" == "true" ]; then
            echo "- âœ… Processed **${{ steps.metadata.outputs.meta_count }}** metadata entries" >> $GITHUB_STEP_SUMMARY
          fi

          if [ "${{ steps.process.outputs.has_new }}" == "true" ] || [ "${{ steps.metadata.outputs.has_metadata }}" == "true" ]; then
            echo "- âœ… Created release" >> $GITHUB_STEP_SUMMARY
          fi
